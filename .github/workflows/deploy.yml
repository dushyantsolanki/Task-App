name: Deploy Backend to EC2

on:
  workflow_dispatch:

jobs:
  build:
    name: Build Backend
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.13.1"

      # INSTALL BACKEND DEPENDENCIES
      - name: Install backend dependencies
        run: |
          cd backend
          npm install

      # BUILD BACKEND (only if you use TypeScript, else remove)
      - name: Build backend
        run: |
          cd backend
          if [ -f tsconfig.json ]; then
            npm run build
          else
            echo "No TypeScript build needed"
          fi

      # PACKAGE BACKEND ONLY
      - name: Create deployment package
        run: |
          mkdir -p deploy/backend
          cp -r backend/* deploy/backend/

          # remove node_modules for fresh server install
          rm -rf deploy/backend/node_modules

          tar -czf deploy.tar.gz -C deploy .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-package
          path: deploy.tar.gz
          retention-days: 1

  deploy:
    name: Deploy Backend to EC2
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-package

      - name: Deploy via SSH
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USERNAME: ${{ secrets.EC2_USERNAME }}
          SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
        run: |
          echo "$SSH_PRIVATE_KEY" > private_key.pem
          chmod 600 private_key.pem

          scp -i private_key.pem -o StrictHostKeyChecking=no deploy.tar.gz ${EC2_USERNAME}@${EC2_HOST}:/tmp/

          ssh -i private_key.pem -o StrictHostKeyChecking=no ${EC2_USERNAME}@${EC2_HOST} << 'EOF'
            cd /Task-App/backend

            sudo chown -R $USER:$USER /Task-App/backend

            # Backup old dist (optional)
            if [ -d "dist" ]; then
              mkdir -p backups
              timestamp=$(date +%Y%m%d_%H%M%S)
              tar -czf backups/backup_${timestamp}.tar.gz dist package.json .env || true
            fi

            echo "Extracting new backend..."
            tar --overwrite -xzf /tmp/deploy.tar.gz -C /Task-App
            rm /tmp/deploy.tar.gz

            sudo chown -R $USER:$USER /Task-App/backend
            cd /Task-App/backend

            echo "Installing dependencies..."
            npm install

            if [ ! -f .env ]; then
              echo "NODE_ENV=production" > .env
              echo "PORT=3000" >> .env
            fi

            # Restart backend using PM2
            if pm2 describe taskmate-backend > /dev/null 2>&1; then
              pm2 reload taskmate-backend
            else
              pm2 start server.js --name taskmate-backend
            fi

            pm2 save
          EOF

          rm private_key.pem

      - name: Verify deployment
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
        run: |
          echo "Waiting for backend..."
          sleep 10

          response=$(curl -s -o /dev/null -w "%{http_code}" http://${EC2_HOST}:3000 || echo "000")
          echo "Status: $response"

          if [ "$response" != "200" ] && [ "$response" != "302" ] && [ "$response" != "301" ]; then
            echo "Backend did not respond"
            exit 1
          fi

          echo "Backend deployed successfully"
